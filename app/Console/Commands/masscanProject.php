<?php
/**
 * Author: Damian Schwyrz <mail@damianschwyrz.de>
 * URL: https://www.damianschwyrz.de
 * Copyright (c) 2018.
 */

namespace App\Console\Commands;

use App\Target;
use App\Task\wc;
use Illuminate\Console\Command;
use Illuminate\Support\Facades\File;
use Symfony\Component\Process\Process;

class masscanProject extends Command
{
    /**
     * The name and signature of the console command.
     *
     * @var string
     */
    protected $signature = 'masscan:project
    {--project=0 : projectId}       
    {--targettype=active : Type of targets} 
    {--limit=1 : How many targets}  
    {--speed=100 : Requests per second} 
    {--ports=0-65535 : scan selected ports}';

    /**
     * The console command description.
     *
     * @var string
     */
    protected $description = 'Scans a random unscanned ips of a given project with masscan';

    protected $targets;

    /**
     * @var string
     */
    protected $cmd = "";

    /**
     * Create a new command instance.
     *
     * @return void
     */
    public function __construct()
    {
        parent::__construct();
    }

    /**
     * Execute the console command.
     *
     * @return mixed
     */
    public function handle()
    {
        list($projectId, $type, $limit, $speed, $ports) = $this->getArguments();


        $this->getTargets($projectId, $limit, $type);

        $this->line("Starting with " . $this->targets->count() . " targets...");
        sleep(3);

        foreach ($this->targets as $target) {

            /**
             * Hi, wondering why we get the data, although we have it already? Check phpdoc!
             */
            if ($this->hasMasscanData($target)) {
                continue;
            }

            if ($this->hasInvalidIp($target)) {
                continue;
            }


            list($outputFile, $outputPath) = $this->makeOutputFileAndPath($target);

            $this->cmd = $this->createCommand($target->ip, $speed, $ports, $outputPath);

            $this->question("Target: " . $target->subdomain . " IP: " . $this->ip);
            $this->line("Executed command: " . $this->cmd);


            $this->executeCmd($this->cmd);

            if (!$this->checkIfReportWasCreated($outputPath)) {
                continue;
            }


            $reportContent = "Full Report: " . asset("storage/masscan/" . $outputFile) . "\n\n";

            $portsDetected = wc::lineCountOfFile($outputPath);

            if ($portsDetected < 100) {
                $reportContent .= File::get($outputPath);
            } else {
                $reportContent .= $portsDetected . " port detected";
            }

            $target->ports_masscan = $reportContent;
            $target->save();

            $message = "Process finished, report saved to file and database.";

            $this->line($message);

        }

    }

    /**
     * @return array
     */
    protected function getArguments(): array
    {
        $projectId = $this->option("project");
        $type = $this->option("targettype");
        $limit = $this->option("limit");
        $speed = $this->option("speed");
        $ports = $this->option("ports");

        return [$projectId, $type, $limit, $speed, $ports];
    }

    /**
     * @param int    $projectId
     * @param int    $limit
     * @param string $type
     */
    private function getTargets(int $projectId, int $limit, string $type)
    {
        $this->targets = Target::where('project_id', $projectId)
            ->whereNull("ports_masscan")
            ->whereNotNull('ip')
            ->inRandomOrder()
            ->take($limit);

        switch ($type) {
            case 'active':
                $this->targets = $this->targets->where("is_archived", 0);
                break;
            case 'archived':
                $this->targets = $this->targets->where("is_archived", 1);
                break;
        }

        $this->targets = $this->targets->get();
    }

    /**
     * Important this seems odd at this place, but sometimes we want to run with high limits like limit=2000 multiple
     * times. In those cases its a good idea to check, if a target was already handles by another process!
     *
     * @param $target
     *
     * @return mixed
     */
    private function hasMasscanData($target)
    {
        $target = Target::find($target->id);

        if (!is_null($target->ports_masscan)) {
            return true;
        }

        return false;


    }

    /**
     * @param $target
     *
     * @return bool
     */
    private function hasInvalidIp($target): bool
    {
        return $target->ip == "0.0.0.0";
    }

    /**
     * @param $target
     *
     * @return array
     */
    protected function makeOutputFileAndPath($target): array
    {
        $outputFile = str_slug($target->subdomain) . "-" . $target->id . ".txt";
        $outputPath = storage_path("app/public/masscan/" . $outputFile);

        return [$outputFile, $outputPath];
    }

    /**
     * @param string $ip
     * @param int    $speed
     * @param string $ports
     * @param string $outputPath
     *
     * @return string
     */
    protected function createCommand(string $ip, int $speed, string $ports, string $outputPath): string
    {
        $cmd = [];

        $cmd[] = config("toolset.path.masscan");
        $cmd[] = "-p" . $ports;
        $cmd[] = $ip;
        $cmd[] = "--rate=" . $speed;
        $cmd[] = '-oL ' . $outputPath;


        $cmd = implode(" ", $cmd);

        return $cmd;
    }

    /**
     * @param string $finaleCommand
     */
    protected function executeCmd(string $finaleCommand)
    {
        $process = new Process($finaleCommand);

        $process->setTimeout(
            config("toolset.masscan.timeout")
        );

        $process->start();
        $process->wait();
    }

    /**
     * @param string $outputPath
     *
     * @return bool
     */
    protected function checkIfReportWasCreated(string $outputPath): bool
    {
        return File::exists($outputPath);
    }
}
