<?php
/**
 * Author: Damian Schwyrz <mail@damianschwyrz.de>
 * URL: https://www.damianschwyrz.de
 * Copyright (c) 2018.
 */

namespace App\Task;

use App\Helper\FileHelper;
use App\Project;
use App\Target;
use Carbon\Carbon;

/**
 * Class BatchProcessSubdomainsFoundViaFacebookCT
 * @package App\Task
 */
class BatchProcessSubdomainsFoundViaFacebookCT
{
    /**
     * @var
     */
    protected $project;

    /**
     * @param $project
     */
    public function setProject(Project $project)
    {
        $this->project = $project;
    }


    public function start($subdomains, $wildcards)
    {

        $subdomains = $this->trimSubdomains($subdomains);
        $subdomains = $this->toLowerCase($subdomains);
        $subdomains = $this->dropEmptyLines($subdomains);

        $subdomains = array_unique($subdomains);
        $subdomains = $this->dropAllSubdomainsWhichExistInDatabase($subdomains);

        $data = $this->createImportData($subdomains);

        Target::insert($data);

        $this->addWildcardDomainsToProject($wildcards);
    }

    /**
     * @param array $$subdomains
     *
     * @return array
     */
    protected function trimSubdomains(array $subdomains): array
    {
        return array_map(function ($string) {
            return trim($string);
        }, $subdomains);
    }

    /**
     * @param array $subdomains
     *
     * @return array
     */
    protected function toLowerCase(array $subdomains): array
    {
        return array_map(function ($string) {
            return strtolower($string);
        }, $subdomains);
    }

    /**
     * @param array $subdomains
     *
     * @return array
     */
    protected function dropEmptyLines(array $subdomains): array
    {
        return array_filter($subdomains, function ($string) {
            return !empty($string);
        });
    }

    /**
     * @param array $subdomains
     *
     * @return array
     */
    protected function dropAllSubdomainsWhichExistInDatabase(array $subdomains): array
    {
        $existingTargets = $this->project->targets()->get()->pluck('subdomain')->flatten()->values();

        return array_filter($subdomains, function ($string) use ($existingTargets) {

            if (is_integer($existingTargets->search($string))) {
                return false;
            }

            return true;
        });
    }

    /**
     * @param $subdomains
     *
     * @return array
     */
    protected function createImportData(array $subdomains): array
    {
        $data = [];
        $now = Carbon::now('utc')->toDateTimeString();

        foreach ($subdomains as $domain) {

            $data[] = [
                'subdomain'  => $domain,
                'status'     => 'new',
                'project_id' => $this->project->id,
                'created_at' => $now,
                'updated_at' => $now,
            ];
        }

        return $data;
    }

    /**
     * @param array $wildcarddomains
     */
    protected function addWildcardDomainsToProject(array $wildcarddomains)
    {
        $oldEntries = [];

        if (!is_null($this->project->other_domains)) {
            $oldEntries = FileHelper::splitContentByLines($this->project->other_domains);
        }

        $newContent = array_merge($oldEntries, $wildcarddomains);
        $newContent = array_unique($newContent);

        $this->project->other_domains = implode("\n", $newContent);
        $this->project->save();
    }


    /**
     * @param array $subdomains
     *
     * @return array
     */
    protected function extractWildcardDomains(array $subdomains): array
    {
        $subdomainTemp = [];
        $wildCardDomains = [];

        foreach ($subdomains as $domain) {
            $firstChar = mb_substr($domain, 0, 1);

            if (in_array($firstChar, ['.', '*'])) {
                $wildCardDomains[] = $domain;
                continue;
            }

            $subdomainTemp[] = $domain;

        }


        return [
            $subdomainTemp,
            $wildCardDomains,
        ];

    }

}