/*
 * Author: Damian Schwyrz <mail@damianschwyrz.de>
 * URL: https://www.damianschwyrz.de
 * Copyright (c) 2018.
 */


$(function () {


    $('#prepare-bruteforce-modal').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget);

        var domain = button.data("domain");
        var route = button.data("href");

        $("#start-bruteforce").data("route", route);
        $("#start-bruteforce").attr("data-route", route);

        $("#bruteforce-domain").val(domain);
    });

    $('#prepare-bruteforce-modal').on('hide.bs.modal', function () {
        $("#bruteforce-domain").val("");
        $("#start-bruteforce").find(".fa").addClass("hidden");

        $("#bruteforce-command span").html();
        $("#bruteforce-killcommand span").html();

        $("#bruteforce-command").fadeOut();
        $("#bruteforce-killcommand").fadeOut();
        $("#bruteforce-warn").fadeOut();

    });

    $(document).on('click', "#start-bruteforce", function (event) {
        event.preventDefault();

        var btn = $(this);
        var route = btn.data("route");

        var domain = $("#bruteforce-domain").val();
        var timeout = $("#bruteforce-timeout").val();
        var report_every = $("#bruteforce-report").val();
        var minParts = $("#bruteforce-min").val();
        var maxParts = $("#bruteforce-max").val();
        var imploder = $("#bruteforce-imploder").val();
        var wordlist_base = $("#bruteforce-wordlist_base").val();
        var wordlist_base_bestcount = $("#bruteforce-wordlist_base_bestcount").val();
        var with_alt_dns = $("#bruteforce-with_alt_dns").val();

        if (minParts <= 0 || isNaN(minParts)) {
            bruteforceError("minParts has to be bigger than 0!");
            return false;
        }

        if (maxParts <= 0 || isNaN(maxParts)) {
            bruteforceError("maxParts has to be bigger than 0!");
            return false;
        }

        if (timeout <= 0 || isNaN(timeout)) {
            bruteforceError("timeout has to be bigger than 0!");
            return false;
        }

        if (report_every <= 0 || isNaN(report_every)) {
            bruteforceError("report has to be bigger than 0!");
            return false;
        }

        if (wordlist_base != "all" && wordlist_base != "project") {
            bruteforceError("wordlist_base has invalid value!");
            return false;
        }

        if (wordlist_base_bestcount < 0 || isNaN(wordlist_base_bestcount)) {
            bruteforceError("wordlist_base_bestcount has to be >= 0");
            return false;
        }

        if ( (with_alt_dns != 0 && with_alt_dns != 1) || isNaN(with_alt_dns)) {
            bruteforceError("with_alt_dns has to be 0 or 1");
            return false;
        }

        if (route == "") {
            bruteforceError("Route not found!");
            return false;
        }

        if (domain == "") {
            bruteforceError("URL has to be set!");
            return false;
        }

        btn.find(".fa").removeClass("hidden");

        $.ajax({
            url: route,
            type: 'POST',
            data: {
                domain: domain,
                min_parts: minParts,
                max_parts: maxParts,
                timeout: timeout,
                imploder: imploder,
                report_every: report_every,
                wordlist_base: wordlist_base,
                wordlist_base_bestcount: wordlist_base_bestcount,
                with_alt_dns: with_alt_dns
            },
            success: function (result) {
                console.log(result);
                $("#bruteforce-command span").html(result.startcommand);
                $("#bruteforce-killcommand span").html(result.killcommand);

                $("#bruteforce-command").fadeIn();
                $("#bruteforce-killcommand").fadeIn();
                $("#bruteforce-warn").fadeIn();
                btn.find(".fa").addClass("hidden");
            },
            error: function (result) {
                console.log(result.responseJSON);
                bruteforceError(result.responseJSON.message);
                btn.find(".fa").addClass("hidden");
            }
        });

    });
});

function bruteforceError(message) {

    $("#bruteforce-error .alert span").html(message);
    $("#bruteforce-error").fadeIn();

    setTimeout(function () {
        $("#bruteforce-error").fadeOut("fast");
        $("#bruteforce-error .alert span").html("");

    }, 3200);
}