/*
 * Author: Damian Schwyrz <mail@damianschwyrz.de>
 * URL: https://www.damianschwyrz.de
 * Copyright (c) 2018.
 */

$(function () {
    $('#prepare-mass-nmap-modal').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget);
        var route = button.data("url");

        $("#start-mass-nmap").data("route", route);
        $("#start-mass-nmap").attr("data-route", route);
    });

    $('#prepare-mass-nmap-modal').on('hide.bs.modal', function () {
        $("#mass-nmap-type").val("quick");
        $("#mass-nmap-port-value").addClass("hidden");
        $("#start-mass-nmap").find(".fa").addClass("hidden");
    });

    $(document).on('click', "#start-mass-nmap", function (event) {
        event.preventDefault();
        var btn = $(this);
        var route = btn.data("route");
        var type = $("#mass-nmap-type").val();
        var ports = $("#mass-nmap-port-value").val();
        var limit = $("#mass-nmap-limit").val();

        if (route == "") {
            nmapMassError("Route not found!");
            return false;
        }


        btn.find(".fa").removeClass("hidden");

        $.ajax({
            url: route,
            type: 'POST',
            data: {
                limit:limit,
                type: type,
                ports: ports
            },
            success: function (result) {
                $('#prepare-mass-nmap-modal').modal('hide');
                loadInfoBox("#infobox", "Mass nmapscan is in queue - come back later ;)");
            },
            error: function (result) {
                console.log(result.responseJSON);
                nmapMassError(result.responseJSON.message);
                btn.find(".fa").addClass("hidden");
            }
        });

    });

    $(document).on('change', "#mass-nmap-type", function (event) {
        if ($(this).val() == "quick") {
            $("#mass-nmap-port-value").addClass("hidden");
        } else {
            $("#mass-nmap-port-value").removeClass("hidden");
        }
    });
});

function nmapMassError(message) {

    $("#mass-nmap-error .alert span").html(message);
    $("#mass-nmap-error").fadeIn();

    setTimeout(function () {
        $("#mass-nmap-error").fadeOut("fast");
        $("#mass-nmap-error .alert span").html("");

    }, 3200);
}