/*
 * Author: Damian Schwyrz <mail@damianschwyrz.de>
 * URL: https://www.damianschwyrz.de
 * Copyright (c) 2018.
 */


$(function () {


    $('#prepare-dirsearch-modal').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget);
        var url = button.data("url");
        var domain = button.data("domain");
        var route = button.data("href");
        var cmdroute = button.data("command-href");


        if (url == "") {
            url = "https://" + domain + "/";
        }

        $("#start-dirsearch").data("route", route);
        $("#start-dirsearch").attr("data-route", route);

        $("#get-command").data("route", cmdroute);
        $("#get-command").attr("data-route", cmdroute);

        $("#dirsearch-url").val(url);
    });

    $('#prepare-dirsearch-modal').on('hide.bs.modal', function () {
        $("#dirsearch-url").val("");
        $("#start-dirsearch").find(".fa").addClass("hidden");
        $("#get-command").find(".fa").addClass("hidden");


        $("#dirsearch-command span").html();
        $("#dirsearch-killcommand span").html();

        $("#dirsearch-command").fadeOut();
        $("#dirsearch-killcommand").fadeOut();

    });

    $(document).on('click', "#get-command", function (event) {
        event.preventDefault();
        var btn = $(this);

        var route = btn.data("route");
        var url = $("#dirsearch-url").val();
        var threads = parseInt($("#dirsearch-threads").val());
        var wordlist = $("#dirsearch-wordlist").val();
        var extensions = $("#dirsearch-extensions").val();
        var ignorestatus = $("#dirsearch-ignore-status").val();
        var recursive = parseInt($("#dirsearch-recursive").val());
        var timeout = parseInt($("#dirsearch-timeout").val());

        if (threads <= 0 || isNaN(threads)) {
            dirsearchError("Threadscount has to be bigger than 0!");
            return false;
        }

        if (route == "") {
            dirsearchError("Route not found!");
            return false;
        }

        if (url == "") {
            dirsearchError("URL has to be set!");
            return false;
        }

        if (wordlist == "") {
            dirsearchError("Wordlist has to be set!");
            return false;
        }

        if (extensions == "") {
            dirsearchError("Extensions has to be set!");
            return false;
        }

        if (ignorestatus == "") {
            dirsearchError("Ignore statuses have to be set!");
            return false;
        }

        if (timeout == "") {
            dirsearchError("timeout has to be set!");
            return false;
        }

        if (isNaN(recursive) || recursive < 0 || recursive > 1) {
            dirsearchError("Recursive has to be 0 or 1");
            return false;
        }

        btn.find(".fa").removeClass("hidden");

        $.ajax({
            url: route,
            type: 'POST',
            data: {
                url: url,
                threads: threads,
                wordlist: wordlist,
                extensions: extensions,
                ignore_status: ignorestatus,
                recursive: recursive,
                timeout: timeout
            },
            success: function (result) {
                console.log(result);
                $("#dirsearch-command span").html(result.startcommand);
                $("#dirsearch-killcommand span").html(result.killcommand);

                $("#dirsearch-command").fadeIn();
                $("#dirsearch-killcommand").fadeIn();

                btn.find(".fa").addClass("hidden");
            },
            error: function (result) {
                console.log(result.responseJSON);
                dirsearchError(result.responseJSON.message);
                btn.find(".fa").addClass("hidden");
            }
        });

    });

    $(document).on('click', "#start-dirsearch", function (event) {
        event.preventDefault();
        var btn = $(this);

        var route = btn.data("route");
        var url = $("#dirsearch-url").val();
        var threads = parseInt($("#dirsearch-threads").val());
        var wordlist = $("#dirsearch-wordlist").val();
        var extensions = $("#dirsearch-extensions").val();
        var ignorestatus = $("#dirsearch-ignore-status").val();
        var recursive = parseInt($("#dirsearch-recursive").val());
        var timeout = parseInt($("#dirsearch-timeout").val());

        if (threads <= 0 || isNaN(threads)) {
            dirsearchError("Threadscount has to be bigger than 0!");
            return false;
        }

        if (route == "") {
            dirsearchError("Route not found!");
            return false;
        }

        if (url == "") {
            dirsearchError("URL has to be set!");
            return false;
        }

        if (wordlist == "") {
            dirsearchError("Wordlist has to be set!");
            return false;
        }

        if (extensions == "") {
            dirsearchError("Extensions has to be set!");
            return false;
        }

        if (ignorestatus == "") {
            dirsearchError("Ignore statuses have to be set!");
            return false;
        }

        if (timeout == "") {
            dirsearchError("timeout has to be set!");
            return false;
        }

        if (isNaN(recursive) || recursive < 0 || recursive > 1) {
            dirsearchError("Recursive has to be 0 or 1");
            return false;
        }

        btn.find(".fa").removeClass("hidden");

        $.ajax({
            url: route,
            type: 'POST',
            data: {
                url: url,
                threads: threads,
                wordlist: wordlist,
                extensions: extensions,
                ignore_status: ignorestatus,
                recursive: recursive,
                timeout: timeout
            },
            success: function (result) {
                $('#prepare-dirsearch-modal').modal('hide');
                loadInfoBox("#infobox", "Dirscan is in queue - come back later ;)");
            },
            error: function (result) {
                console.log(result.responseJSON);
                dirsearchError(result.responseJSON.message);
                btn.find(".fa").addClass("hidden");
            }
        });

    });

});


function dirsearchError(message) {

    $("#dirsearch-error .alert span").html(message);
    $("#dirsearch-error").fadeIn();

    setTimeout(function () {
        $("#dirsearch-error").fadeOut("fast");
        $("#dirsearch-error .alert span").html("");

    }, 3200);
}