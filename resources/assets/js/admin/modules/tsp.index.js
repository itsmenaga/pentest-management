/*
 * Author: Damian Schwyrz <mail@damianschwyrz.de>
 * URL: https://www.damianschwyrz.de
 * Copyright (c) 2018.
 */

$(function () {
    updateTspFrame();

    setInterval(function () {
        updateTspFrame();
    }, 4500);


    $(document).on('click', '#tsp-clear', function (event) {
        event.preventDefault();
        $.ajax({
            url: $(this).attr("href"),
            type: 'POST',
            complete: function (result) {
                console.log(result);
                updateTspFrame();
            }
        });
    });

    $(document).on('click', '#tsp-remove-not-started', function (event) {
        event.preventDefault();
        $(".tsp-process-wrapper").each(function () {
            var route = $(this).data('dequeu-route');
            var status = $(this).data('status');
            if (status === "queued") {
                $.ajax({
                    url: route,
                    type: 'DELETE',
                    complete: function (result) {
                        console.log(result);
                    }
                });
            }
        });

        updateTspFrame();
    });


    $(document).on('click', '.kill-from-tsp', function (event) {
        event.preventDefault();
        $.ajax({
            url: $(this).attr("href"),
            type: 'DELETE',
            complete: function (result) {
                console.log(result);
                updateTspFrame();
            }
        });
    });

    $(document).on('click', '.prioritize-from-tsp', function (event) {
        event.preventDefault();
        $.ajax({
            url: $(this).attr("href"),
            type: 'PATCH',
            complete: function (result) {
                console.log(result);
                updateTspFrame();
            }
        });
    });

    $(document).on('click', '.deque-from-tsp', function (event) {
        event.preventDefault();
        $.ajax({
            url: $(this).attr("href"),
            type: 'DELETE',
            complete: function (result) {
                console.log(result);
                updateTspFrame();
            }
        });
    });

    $(document).on('click', '.show-tempfile', function (event) {
        event.preventDefault();

        var wrapper = $("#task-spooler-current-process-wrapper");
        var spinner = $("#task-spooler-current-process-wrapper #task-spooler-current-process .fa-spinner");
        var content = $("#task-spooler-current-process-wrapper #task-spooler-current-process #content-tsp");

        content.html("");
        spinner.removeClass("hidden");
        wrapper.removeClass("hidden");

        $.ajax({
            url: $(this).attr("href"),
            type: 'POST',
            data: {
                file: $(this).data('file')
            },
            complete: function (result) {

                if (result.responseJSON.output != "") {
                    spinner.addClass("hidden");
                    content.html(result.responseJSON.output);
                } else {
                    wrapper.addClass("hidden");
                    content.html("");
                    spinner.addClass("hidden");
                }
            }
        });
    });
});

function updateTspFrame() {
    $("#tsp-update-spinner").removeClass("hidden");
    $.ajax({
        url: tsp_get_route,
        type: 'GET',
        success: function (result) {
            $("#task-spooler-out").html(result.output);
            $("#tsp-update-spinner").addClass("hidden");
        }
    });
}
